import React, { useState, useEffect } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Button,
  IconButton,
  Grid,
  Chip,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Snackbar,
  Alert,
  CircularProgress,
  Stack,
  Menu,
  MenuItem,
  ListItemIcon,
  ListItemText,
  Divider,
  Tabs,
  Tab,
} from '@mui/material';
import {
  RestoreOutlined,
  DeleteForeverOutlined,
  FolderOutlined,
  MoreVertOutlined,
  WarningAmberOutlined,
  InfoOutlined,
  Assignment,
  Archive,
  Unarchive,
  DeleteOutlined,
} from '@mui/icons-material';
import { formatDistanceToNow } from 'date-fns';
import { ko } from 'date-fns/locale';
import { workspaceAPI, surveyAPI } from '../services/apiService';

interface TrashedWorkspace {
  id: string;
  name: string;
  description?: string;
  deleted_at: string;
  surveys_count: number;
  responses_count: number;
}

interface ArchivedSurvey {
  id: string;
  title: string;
  description?: string;
  workspace_name: string;
  archived_at: string;
  responses_count: number;
  scale_max: number;
}

const Trash: React.FC = () => {
  const [currentTab, setCurrentTab] = useState(0);
  const [workspaces, setWorkspaces] = useState<TrashedWorkspace[]>([]);
  const [surveys, setSurveys] = useState<ArchivedSurvey[]>([]);
  const [deletedSurveys, setDeletedSurveys] = useState<ArchivedSurvey[]>([]);
  const [loading, setLoading] = useState(true);
  const [actionLoading, setActionLoading] = useState<string | null>(null);
  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false);
  const [restoreConfirmOpen, setRestoreConfirmOpen] = useState(false);
  const [selectedWorkspace, setSelectedWorkspace] = useState<TrashedWorkspace | null>(null);
  const [selectedSurvey, setSelectedSurvey] = useState<ArchivedSurvey | null>(null);
  const [anchorEl, setAnchorEl] = useState<null | HTMLElement>(null);
  const [snackbar, setSnackbar] = useState({
    open: false,
    message: '',
    severity: 'success' as 'success' | 'error' | 'warning' | 'info',
  });

  const fetchTrashedData = async () => {
    try {
      setLoading(true);
      
      // ÏûÑÏãúÎ°ú Îπà ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Îç∞Ïù¥ÌÑ∞
      setWorkspaces([]);
      
      // 1. ÏÑ§Î¨∏ Ìú¥ÏßÄÌÜµ Ï°∞Ìöå (inactive ÏÉÅÌÉúÏùò ÏÑ§Î¨∏Îì§)
      try {
        // Î™®Îì† ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Ïù¥Î¶Ñ Îß§ÌïëÏö©)
        const allWorkspaces = await workspaceAPI.getAll();
        const workspaceMap = new Map(allWorkspaces.map(ws => [ws.id, ws.title]));
        
        // Í∞Å ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§Ïùò ÏÑ§Î¨∏ÏùÑ Í∞ÄÏ†∏ÏôÄÏÑú inactive ÌïÑÌÑ∞ÎßÅ
        const allSurveyPromises = allWorkspaces.map(ws => surveyAPI.getByWorkspace(ws.id));
        const allSurveyArrays = await Promise.all(allSurveyPromises);
        const allSurveys = allSurveyArrays.flat();
        
        console.log('üì• Î™®Îì† ÏÑ§Î¨∏ Îç∞Ïù¥ÌÑ∞:', allSurveys);
        
        const inactiveSurveys = allSurveys.filter((survey: any) => survey.status === 'inactive');
        console.log('üóëÔ∏è Ìú¥ÏßÄÌÜµ ÏÑ§Î¨∏ (inactive):', inactiveSurveys);
        
        const formattedDeletedSurveys = inactiveSurveys.map((survey: any) => ({
          id: survey.id,
          title: survey.title,
          description: survey.description || '',
          workspace_name: workspaceMap.get(survey.workspace_id) || 'Ïïå Ïàò ÏóÜÎäî ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§',
          archived_at: survey.updated_at || survey.created_at,
          responses_count: survey.response_count || 0,
          scale_max: survey.scale_max || 5,
        }));
        setDeletedSurveys(formattedDeletedSurveys);
        console.log('üóëÔ∏è Ìú¥ÏßÄÌÜµ ÏÑ§Î¨∏ Í∞úÏàò:', formattedDeletedSurveys.length);
      } catch (error) {
        console.error('Ìú¥ÏßÄÌÜµ ÏÑ§Î¨∏ Ï°∞Ìöå Ïã§Ìå®:', error);
        setDeletedSurveys([]);
      }
      
      // 2. ÏÑ§Î¨∏ Î≥¥Í¥ÄÌï® Ï°∞Ìöå - ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Ìú¥ÏßÄÌÜµ APIÎ•º ÌôúÏö© (Ïã§Ï†úÎ°úÎäî ÏÑ§Î¨∏ Îç∞Ïù¥ÌÑ∞)
      try {
        const workspaceResponse = await workspaceAPI.getTrashedWorkspaces();
        console.log('üì• ÏÑ§Î¨∏ Î≥¥Í¥ÄÌï® ÏùëÎãµ (ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ API ÌôúÏö©):', workspaceResponse);
        
        // ÏùëÎãµ Íµ¨Ï°∞: {surveys: [...], total_count: number}
        const response = workspaceResponse as any; // Ïã§Ï†ú ÏùëÎãµ Íµ¨Ï°∞Ïóê ÎßûÍ≤å Ï∫êÏä§ÌåÖ
        const surveysData = response?.data?.surveys || response?.surveys || [];
        const formattedSurveys = surveysData.map((survey: any) => ({
          id: survey.id,
          title: survey.title,
          description: survey.description || '',
          workspace_name: survey.workspace_name || 'Ïïå Ïàò ÏóÜÎäî ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§',
          archived_at: survey.updated_at || survey.created_at,
          responses_count: survey.response_count || 0,
          scale_max: survey.scale_max || 5,
        }));
        setSurveys(formattedSurveys);
        console.log('üìã Î≥¥Í¥ÄÌï® ÏÑ§Î¨∏ Í∞úÏàò:', formattedSurveys.length);
      } catch (surveyError) {
        console.error('Î≥¥Í¥ÄÎêú ÏÑ§Î¨∏ Ï°∞Ìöå Ïã§Ìå®:', surveyError);
        setSurveys([]);
      }
      
    } catch (error: any) {
      console.error('Ìú¥ÏßÄÌÜµ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
      setSnackbar({
        open: true,
        message: 'Ìú¥ÏßÄÌÜµ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.',
        severity: 'error',
      });
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchTrashedData();
  }, []);

  const handleMenuOpen = (event: React.MouseEvent<HTMLElement>, item: TrashedWorkspace | ArchivedSurvey, type: 'workspace' | 'survey') => {
    setAnchorEl(event.currentTarget);
    if (type === 'workspace') {
      setSelectedWorkspace(item as TrashedWorkspace);
      setSelectedSurvey(null);
    } else {
      setSelectedSurvey(item as ArchivedSurvey);
      setSelectedWorkspace(null);
    }
  };

  const handleMenuClose = () => {
    setAnchorEl(null);
    setSelectedWorkspace(null);
    setSelectedSurvey(null);
  };

  const handleRestoreWorkspace = async () => {
    if (!selectedWorkspace) return;

    try {
      setActionLoading(selectedWorkspace.id);
      await workspaceAPI.restoreWorkspace(selectedWorkspace.id);
      
      setSnackbar({
        open: true,
        message: `"${selectedWorkspace.name}" ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§Í∞Ä Î≥µÍµ¨ÎêòÏóàÏäµÎãàÎã§.`,
        severity: 'success',
      });
      
      setWorkspaces(prev => prev.filter(w => w.id !== selectedWorkspace.id));
    } catch (error: any) {
      console.error('ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Î≥µÍµ¨ Ïã§Ìå®:', error);
      setSnackbar({
        open: true,
        message: 'ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Î≥µÍµ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.',
        severity: 'error',
      });
    } finally {
      setActionLoading(null);
      setRestoreConfirmOpen(false);
      handleMenuClose();
    }
  };

  const handleRestoreSurvey = async () => {
    if (!selectedSurvey) return;

    try {
      setActionLoading(selectedSurvey.id);
      console.log('üì§ ÏÑ§Î¨∏ Î≥µÍµ¨ ÏöîÏ≤≠:', selectedSurvey.id);
      
      await surveyAPI.updateStatus(selectedSurvey.id, 'active');
      console.log('‚úÖ ÏÑ§Î¨∏ Î≥µÍµ¨ ÏÑ±Í≥µ:', selectedSurvey.id);
      
      setSnackbar({
        open: true,
        message: `"${selectedSurvey.title}" ÏÑ§Î¨∏Ïù¥ Î≥µÍµ¨ÎêòÏóàÏäµÎãàÎã§.`,
        severity: 'success',
      });
      
      // Î°úÏª¨ ÏÉÅÌÉúÏóêÏÑú Ï¶âÏãú Ï†úÍ±∞ - ÌòÑÏû¨ ÌÉ≠Ïóê Îî∞Îùº Ï†ÅÏ†àÌïú state ÏóÖÎç∞Ïù¥Ìä∏
      if (currentTab === 0) {
        // ÏÑ§Î¨∏ Ìú¥ÏßÄÌÜµÏóêÏÑú Î≥µÍµ¨
        setDeletedSurveys(prev => prev.filter(s => s.id !== selectedSurvey.id));
      } else {
        // ÏÑ§Î¨∏ Î≥¥Í¥ÄÌï®ÏóêÏÑú Î≥µÍµ¨
        setSurveys(prev => prev.filter(s => s.id !== selectedSurvey.id));
      }
      
      // 0.5Ï¥à ÌõÑ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ ÌôïÏã§Ìûà Î∞òÏòÅ
      setTimeout(() => {
        fetchTrashedData();
        console.log('üîÑ ÏÑ§Î¨∏ Î≥µÍµ¨ ÌõÑ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å');
      }, 500);
      
    } catch (error: any) {
      console.error('‚ùå ÏÑ§Î¨∏ Î≥µÍµ¨ Ïã§Ìå®:', error);
      setSnackbar({
        open: true,
        message: `ÏÑ§Î¨∏ Î≥µÍµ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${error.message}`,
        severity: 'error',
      });
    } finally {
      setActionLoading(null);
      setRestoreConfirmOpen(false);
      handleMenuClose();
    }
  };

  const handleDeleteWorkspace = async () => {
    if (!selectedWorkspace) return;

    try {
      setActionLoading(selectedWorkspace.id);
      await workspaceAPI.deleteWorkspacePermanently(selectedWorkspace.id);
      
      setSnackbar({
        open: true,
        message: `"${selectedWorkspace.name}" ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§Í∞Ä ÏòÅÍµ¨ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`,
        severity: 'success',
      });
      
      setWorkspaces(prev => prev.filter(w => w.id !== selectedWorkspace.id));
    } catch (error: any) {
      console.error('ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ ÏòÅÍµ¨ ÏÇ≠Ï†ú Ïã§Ìå®:', error);
      setSnackbar({
        open: true,
        message: 'ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ ÏòÅÍµ¨ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.',
        severity: 'error',
      });
    } finally {
      setActionLoading(null);
      setDeleteConfirmOpen(false);
      handleMenuClose();
    }
  };

  const handleDeleteSurvey = async () => {
    if (!selectedSurvey) return;

    try {
      setActionLoading(selectedSurvey.id);
      await surveyAPI.delete(selectedSurvey.id);
      
      setSnackbar({
        open: true,
        message: `"${selectedSurvey.title}" ÏÑ§Î¨∏Ïù¥ ÏòÅÍµ¨ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`,
        severity: 'success',
      });
      
      // Î°úÏª¨ ÏÉÅÌÉúÏóêÏÑú Ï¶âÏãú Ï†úÍ±∞ - ÌòÑÏû¨ ÌÉ≠Ïóê Îî∞Îùº Ï†ÅÏ†àÌïú state ÏóÖÎç∞Ïù¥Ìä∏
      if (currentTab === 0) {
        // ÏÑ§Î¨∏ Ìú¥ÏßÄÌÜµÏóêÏÑú ÏÇ≠Ï†ú
        setDeletedSurveys(prev => prev.filter(s => s.id !== selectedSurvey.id));
      } else {
        // ÏÑ§Î¨∏ Î≥¥Í¥ÄÌï®ÏóêÏÑú ÏÇ≠Ï†ú
        setSurveys(prev => prev.filter(s => s.id !== selectedSurvey.id));
      }
    } catch (error: any) {
      console.error('ÏÑ§Î¨∏ ÏòÅÍµ¨ ÏÇ≠Ï†ú Ïã§Ìå®:', error);
      setSnackbar({
        open: true,
        message: 'ÏÑ§Î¨∏ ÏòÅÍµ¨ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.',
        severity: 'error',
      });
    } finally {
      setActionLoading(null);
      setDeleteConfirmOpen(false);
      handleMenuClose();
    }
  };

  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '60vh' }}>
        <CircularProgress />
      </Box>
    );
  }

  return (
    <Box sx={{ p: 3 }}>
      {/* Ìó§Îçî */}
      <Box sx={{ mb: 4 }}>
        <Typography variant="h4" sx={{ fontWeight: 700, color: '#111827', mb: 1 }}>
          Ìú¥ÏßÄÌÜµ Î∞è Î≥¥Í¥ÄÌï®
        </Typography>
        <Typography variant="body1" sx={{ color: '#6B7280' }}>
          ÏÇ≠Ï†úÎêú ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ÏôÄ Î≥¥Í¥ÄÎêú ÏÑ§Î¨∏ÏùÑ Í¥ÄÎ¶¨Ìï©ÎãàÎã§. 30Ïùº ÌõÑ ÏûêÎèôÏúºÎ°ú ÏòÅÍµ¨ ÏÇ≠Ï†úÎê©ÎãàÎã§.
        </Typography>
      </Box>

      {/* ÌÉ≠ */}
      <Box sx={{ borderBottom: 1, borderColor: 'divider', mb: 3 }}>
        <Tabs value={currentTab} onChange={(e, newValue) => setCurrentTab(newValue)}>
          <Tab label={`ÏÑ§Î¨∏ Ìú¥ÏßÄÌÜµ (${deletedSurveys.length})`} />
          <Tab label={`ÏÑ§Î¨∏ Î≥¥Í¥ÄÌï® (${surveys.length})`} />
        </Tabs>
      </Box>

      {/* ÏïàÎÇ¥ Î©îÏãúÏßÄ */}
      <Card sx={{ mb: 3, backgroundColor: '#FEF3C7', border: '1px solid #F59E0B' }}>
        <CardContent sx={{ py: 2 }}>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <WarningAmberOutlined sx={{ color: '#F59E0B', fontSize: 20 }} />
            <Typography variant="body2" sx={{ color: '#92400E' }}>
              {currentTab === 0 
                ? 'Ìú¥ÏßÄÌÜµÏùò ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§Îäî 30Ïùº ÌõÑ ÏûêÎèôÏúºÎ°ú ÏòÅÍµ¨ ÏÇ≠Ï†úÎê©ÎãàÎã§.' 
                : 'Î≥¥Í¥ÄÎêú ÏÑ§Î¨∏ÏùÄ Ïñ∏Ï†úÎì†ÏßÄ Î≥µÍµ¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.'
              }
            </Typography>
          </Box>
        </CardContent>
      </Card>

      {/* Ïª®ÌÖêÏ∏† */}
      {currentTab === 0 ? (
        // ÏÑ§Î¨∏ Ìú¥ÏßÄÌÜµ
        deletedSurveys.length === 0 ? (
          <Card sx={{ textAlign: 'center', py: 8 }}>
            <CardContent>
              <DeleteOutlined sx={{ fontSize: 64, color: '#9CA3AF', mb: 2 }} />
              <Typography variant="h6" sx={{ color: '#6B7280', mb: 1 }}>
                Ìú¥ÏßÄÌÜµÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§
              </Typography>
              <Typography variant="body2" sx={{ color: '#9CA3AF' }}>
                ÏÇ≠Ï†úÎêú ÏÑ§Î¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.
              </Typography>
            </CardContent>
          </Card>
        ) : (
          <Box
            sx={{
              display: 'grid',
              gridTemplateColumns: {
                xs: '1fr',
                sm: 'repeat(2, 1fr)',
                md: 'repeat(3, 1fr)',
              },
              gap: 3,
            }}
          >
            {deletedSurveys.map((survey) => (
              <Card
                key={survey.id}
                sx={{
                  height: '100%',
                  display: 'flex',
                  flexDirection: 'column',
                  position: 'relative',
                  border: '1px solid #E5E7EB',
                  backgroundColor: '#FEF2F2',
                  transition: 'all 0.2s ease-in-out',
                  '&:hover': {
                    boxShadow: '0 4px 12px rgba(0, 0, 0, 0.1)',
                    transform: 'translateY(-2px)',
                  },
                }}
              >
                <CardContent sx={{ flex: 1, p: 3 }}>
                  {/* Ìó§Îçî */}
                  <Box sx={{ display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', mb: 2 }}>
                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5, flex: 1 }}>
                      <Box
                        sx={{
                          width: 40,
                          height: 40,
                          backgroundColor: '#FCA5A5',
                          borderRadius: 2,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                        }}
                      >
                        <DeleteOutlined sx={{ color: '#DC2626', fontSize: 20 }} />
                      </Box>
                      <Box sx={{ flex: 1, minWidth: 0 }}>
                        <Typography
                          variant="h6"
                          sx={{
                            fontWeight: 600,
                            color: '#111827',
                            fontSize: '1.1rem',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap',
                          }}
                        >
                          {survey.title}
                        </Typography>
                        <Typography
                          variant="caption"
                          sx={{
                            color: '#6B7280',
                            display: 'block',
                          }}
                        >
                          {survey.workspace_name}
                        </Typography>
                      </Box>
                    </Box>
                    <IconButton
                      size="small"
                      onClick={(e) => handleMenuOpen(e, survey, 'survey')}
                      disabled={actionLoading === survey.id}
                      sx={{ color: '#6B7280' }}
                    >
                      {actionLoading === survey.id ? (
                        <CircularProgress size={16} />
                      ) : (
                        <MoreVertOutlined fontSize="small" />
                      )}
                    </IconButton>
                  </Box>

                  {/* ÏÑ§Î™Ö */}
                  {survey.description && (
                    <Typography
                      variant="body2"
                      sx={{
                        color: '#6B7280',
                        mb: 2,
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                        display: '-webkit-box',
                        WebkitLineClamp: 2,
                        WebkitBoxOrient: 'vertical',
                      }}
                    >
                      {survey.description}
                    </Typography>
                  )}

                  {/* ÌÜµÍ≥Ñ */}
                  <Stack direction="row" spacing={1} sx={{ mb: 2 }}>
                    <Chip
                      label={`Ï†êÏàò Ïä§ÏºÄÏùº 1-${survey.scale_max}`}
                      size="small"
                      sx={{ backgroundColor: '#FCA5A5', color: '#DC2626' }}
                    />
                    <Chip
                      label={`ÏùëÎãµ ${survey.responses_count}Í∞ú`}
                      size="small"
                      sx={{ backgroundColor: '#FCA5A5', color: '#DC2626' }}
                    />
                  </Stack>

                  {/* ÏÇ≠Ï†ú ÏãúÍ∞Ñ */}
                  <Typography variant="caption" sx={{ color: '#9CA3AF' }}>
                    {formatDistanceToNow(new Date(survey.archived_at), {
                      addSuffix: true,
                      locale: ko,
                    })} ÏÇ≠Ï†úÎê®
                  </Typography>
                </CardContent>
              </Card>
            ))}
          </Box>
        )
      ) : (
        // ÏÑ§Î¨∏ Î≥¥Í¥ÄÌï®
        surveys.length === 0 ? (
          <Card sx={{ textAlign: 'center', py: 8 }}>
            <CardContent>
              <Archive sx={{ fontSize: 64, color: '#9CA3AF', mb: 2 }} />
              <Typography variant="h6" sx={{ color: '#6B7280', mb: 1 }}>
                Î≥¥Í¥ÄÌï®Ïù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§
              </Typography>
              <Typography variant="body2" sx={{ color: '#9CA3AF' }}>
                Î≥¥Í¥ÄÎêú ÏÑ§Î¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.
              </Typography>
            </CardContent>
          </Card>
        ) : (
          <Box
            sx={{
              display: 'grid',
              gridTemplateColumns: {
                xs: '1fr',
                sm: 'repeat(2, 1fr)',
                md: 'repeat(3, 1fr)',
              },
              gap: 3,
            }}
          >
            {surveys.map((survey) => (
              <Card
                key={survey.id}
                sx={{
                  height: '100%',
                  display: 'flex',
                  flexDirection: 'column',
                  position: 'relative',
                  border: '1px solid #E5E7EB',
                  backgroundColor: '#FFF8F0',
                  transition: 'all 0.2s ease-in-out',
                  '&:hover': {
                    boxShadow: '0 4px 12px rgba(0, 0, 0, 0.1)',
                    transform: 'translateY(-2px)',
                  },
                }}
              >
                <CardContent sx={{ flex: 1, p: 3 }}>
                  {/* Ìó§Îçî */}
                  <Box sx={{ display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', mb: 2 }}>
                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5, flex: 1 }}>
                      <Box
                        sx={{
                          width: 40,
                          height: 40,
                          backgroundColor: '#FED7AA',
                          borderRadius: 2,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                        }}
                      >
                        <Assignment sx={{ color: '#EA580C', fontSize: 20 }} />
                      </Box>
                      <Box sx={{ flex: 1, minWidth: 0 }}>
                        <Typography
                          variant="h6"
                          sx={{
                            fontWeight: 600,
                            color: '#111827',
                            fontSize: '1.1rem',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap',
                          }}
                        >
                          {survey.title}
                        </Typography>
                        <Typography
                          variant="caption"
                          sx={{
                            color: '#6B7280',
                            display: 'block',
                          }}
                        >
                          {survey.workspace_name}
                        </Typography>
                      </Box>
                    </Box>
                    <IconButton
                      size="small"
                      onClick={(e) => handleMenuOpen(e, survey, 'survey')}
                      disabled={actionLoading === survey.id}
                      sx={{ color: '#6B7280' }}
                    >
                      {actionLoading === survey.id ? (
                        <CircularProgress size={16} />
                      ) : (
                        <MoreVertOutlined fontSize="small" />
                      )}
                    </IconButton>
                  </Box>

                  {/* ÏÑ§Î™Ö */}
                  {survey.description && (
                    <Typography
                      variant="body2"
                      sx={{
                        color: '#6B7280',
                        mb: 2,
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                        display: '-webkit-box',
                        WebkitLineClamp: 2,
                        WebkitBoxOrient: 'vertical',
                      }}
                    >
                      {survey.description}
                    </Typography>
                  )}

                  {/* ÌÜµÍ≥Ñ */}
                  <Stack direction="row" spacing={1} sx={{ mb: 2 }}>
                    <Chip
                      label={`Ï†êÏàò Ïä§ÏºÄÏùº 1-${survey.scale_max}`}
                      size="small"
                      sx={{ backgroundColor: '#FED7AA', color: '#EA580C' }}
                    />
                    <Chip
                      label={`ÏùëÎãµ ${survey.responses_count}Í∞ú`}
                      size="small"
                      sx={{ backgroundColor: '#FED7AA', color: '#EA580C' }}
                    />
                  </Stack>

                  {/* Î≥¥Í¥Ä ÏãúÍ∞Ñ */}
                  <Typography variant="caption" sx={{ color: '#9CA3AF' }}>
                    {formatDistanceToNow(new Date(survey.archived_at), {
                      addSuffix: true,
                      locale: ko,
                    })} Î≥¥Í¥ÄÎê®
                  </Typography>
                </CardContent>
              </Card>
            ))}
          </Box>
        )
      )}

      {/* Î©îÎâ¥ */}
      <Menu
        anchorEl={anchorEl}
        open={Boolean(anchorEl)}
        onClose={handleMenuClose}
        PaperProps={{
          sx: { minWidth: 200 }
        }}
      >
        <MenuItem
          onClick={() => {
            setRestoreConfirmOpen(true);
            // handleMenuClose(); // Î©îÎâ¥Î•º Îã´ÏúºÎ©¥ selectedSurveyÍ∞Ä nullÏù¥ ÎêòÎØÄÎ°ú Ï£ºÏÑù Ï≤òÎ¶¨
            setAnchorEl(null); // Î©îÎâ¥Îßå Îã´Í∏∞
          }}
        >
          <ListItemIcon>
            <RestoreOutlined fontSize="small" sx={{ color: '#059669' }} />
          </ListItemIcon>
          <ListItemText>Î≥µÍµ¨</ListItemText>
        </MenuItem>
        <Divider />
        <MenuItem
          onClick={() => {
            setDeleteConfirmOpen(true);
            // handleMenuClose(); // Î©îÎâ¥Î•º Îã´ÏúºÎ©¥ selectedSurveyÍ∞Ä nullÏù¥ ÎêòÎØÄÎ°ú Ï£ºÏÑù Ï≤òÎ¶¨
            setAnchorEl(null); // Î©îÎâ¥Îßå Îã´Í∏∞
          }}
          sx={{ color: '#DC2626' }}
        >
          <ListItemIcon>
            <DeleteForeverOutlined fontSize="small" sx={{ color: '#DC2626' }} />
          </ListItemIcon>
          <ListItemText>ÏòÅÍµ¨ ÏÇ≠Ï†ú</ListItemText>
        </MenuItem>
      </Menu>

      {/* Î≥µÍµ¨ ÌôïÏù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
      <Dialog open={restoreConfirmOpen} onClose={() => {
        setRestoreConfirmOpen(false);
        setSelectedWorkspace(null);
        setSelectedSurvey(null);
      }}>
        <DialogTitle>
          {selectedWorkspace ? 'ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Î≥µÍµ¨' : 'ÏÑ§Î¨∏ Î≥µÍµ¨'}
        </DialogTitle>
        <DialogContent>
          <Typography>
            "{selectedWorkspace?.name || selectedSurvey?.title}"ÏùÑ(Î•º) Î≥µÍµ¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?
            <br />
            Î≥µÍµ¨Îêú {selectedWorkspace ? 'ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§Îäî Îã§Ïãú ÌôúÏÑ± ÏÉÅÌÉúÍ∞Ä' : 'ÏÑ§Î¨∏ÏùÄ Îã§Ïãú ÌôúÏÑ± ÏÉÅÌÉúÎ°ú'} Îê©ÎãàÎã§.
          </Typography>
          {selectedSurvey && (
            <Typography variant="body2" sx={{ mt: 2, color: '#6B7280' }}>
              üí° Î≥µÍµ¨Îêú ÏÑ§Î¨∏ÏùÄ "{selectedSurvey.workspace_name}" ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ÏóêÏÑú ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.
            </Typography>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => {
            setRestoreConfirmOpen(false);
            setSelectedWorkspace(null);
            setSelectedSurvey(null);
          }}>Ï∑®ÏÜå</Button>
          <Button 
            variant="contained" 
            onClick={selectedWorkspace ? handleRestoreWorkspace : handleRestoreSurvey} 
            sx={{ backgroundColor: '#059669' }}
          >
            Î≥µÍµ¨
          </Button>
        </DialogActions>
      </Dialog>

      {/* ÏòÅÍµ¨ ÏÇ≠Ï†ú ÌôïÏù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
      <Dialog open={deleteConfirmOpen} onClose={() => {
        setDeleteConfirmOpen(false);
        setSelectedWorkspace(null);
        setSelectedSurvey(null);
      }}>
        <DialogTitle sx={{ color: '#DC2626' }}>ÏòÅÍµ¨ ÏÇ≠Ï†ú</DialogTitle>
        <DialogContent>
          <Typography sx={{ mb: 2 }}>
            "{selectedWorkspace?.name || selectedSurvey?.title}"ÏùÑ(Î•º) <strong>ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†ú</strong>ÌïòÏãúÍ≤†ÏäµÎãàÍπå?
          </Typography>
          <Typography variant="body2" sx={{ color: '#DC2626' }}>
            ‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏúºÎ©∞, Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏôÑÏ†ÑÌûà ÏÇ≠Ï†úÎê©ÎãàÎã§.
          </Typography>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => {
            setDeleteConfirmOpen(false);
            setSelectedWorkspace(null);
            setSelectedSurvey(null);
          }}>Ï∑®ÏÜå</Button>
          <Button 
            variant="contained" 
            color="error" 
            onClick={selectedWorkspace ? handleDeleteWorkspace : handleDeleteSurvey}
          >
            ÏòÅÍµ¨ ÏÇ≠Ï†ú
          </Button>
        </DialogActions>
      </Dialog>

      {/* Ïä§ÎÇµÎ∞î */}
      <Snackbar
        open={snackbar.open}
        autoHideDuration={4000}
        onClose={() => setSnackbar({ ...snackbar, open: false })}
      >
        <Alert severity={snackbar.severity} onClose={() => setSnackbar({ ...snackbar, open: false })}>
          {snackbar.message}
        </Alert>
      </Snackbar>
    </Box>
  );
};

export default Trash; 